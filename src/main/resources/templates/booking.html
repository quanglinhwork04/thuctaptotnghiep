<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://code.jquery.com/jquery-3.6.3.js" integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <title>Đặt lịch</title>
  <link rel="shortcut icon" href="images/favicon.ico">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <!-- LOADING FONTS AND ICONS -->
  <link rel="stylesheet" type="text/css" href="css/pe-icon-7-stroke.css">
  <link rel="stylesheet" type="text/css" href="css/font-awesome.css">
  <!-- REVOLUTION STYLE SHEETS -->
  <link rel="stylesheet" type="text/css" href="css/rs6.css">
  <!-- Owl Carousel CSS -->
  <link rel="stylesheet" href="css/owl.carousel.min.css">
  <!-- Progressbar CSS -->
  <link rel="stylesheet" href="css/progressbar.css">
  <!-- Animation CSS -->
  <link rel="stylesheet" href="css/animations.min.css">
  <!-- Magnefic Popup CSS -->
  <link rel="stylesheet" href="css/magnific-popup.min.css">
  <!-- Icons CSS -->
  <link rel="stylesheet" href="css/all.min.css">
  <link rel="stylesheet" href="css/flaticon.css">
  <link rel="stylesheet" href="css/ionicons.min.css">
  <link rel="stylesheet" href="css/themify-icons.css">
  <!--  Style CSS -->
  <link rel="stylesheet" href="css/style.css">
  <!--  Responsive CSS -->
  <link rel="stylesheet" href="css/responsive.css">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .booking-section { position: relative; padding: 5rem 0; background-color: #f8fafc; overflow: hidden; }
    .booking-shape { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.15; z-index: 0; }
    .booking-shape svg { width: 100%; height: 100%; }
    .booking-container { position: relative; z-index: 10; }
    .booking-title { font-size: 4.5rem; font-weight: 700; color: #1f2937; margin: 0; }
    .booking-subtitle { font-size: 2rem; font-weight: 600; color: #3b82f6; text-transform: uppercase; margin-bottom: 0.5rem; }
    .form-field { width: 100%; padding: 0.4rem 0.6rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.85rem; color: #374151; line-height: 1.5; margin-bottom: 0; }
    .form-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .form-label { display: block; font-size: 0.85rem; font-weight: 500; color: #1f2937; margin-bottom: 0.2rem; }
    .form-select-custom { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.6rem center; background-size: 1em; padding-right: 1.8rem; white-space: normal; text-overflow: clip; min-height: 2.25rem; margin-bottom: 0; }
    .form-select-custom option { white-space: normal; padding: 0.3rem; font-size: 0.85rem; }
    .form-textarea { resize: vertical; min-height: 70px; margin-bottom: 0; }
    .btn-submit { margin-top: 0.5rem; display: inline-flex; align-items: center; padding: 0.5rem 1.2rem; background: linear-gradient(to right, #3b82f6, #60a5fa); color: #ffffff; font-size: 0.85rem; font-weight: 600; border-radius: 0.375rem; border: none; transition: all 0.3s ease; }
    .btn-submit:hover { background: linear-gradient(to right, #2563eb, #3b82f6); transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    .btn-submit img { margin-left: 0.3rem; width: 12px; height: 12px; }
    .alert-danger { background-color: #fee2e2; color: #dc2626; padding: 0.5rem; border-radius: 0.375rem; margin-bottom: 0.6rem; font-size: 0.75rem; }
    .alert-success { background-color: #d1fae5; color: #059669; padding: 0.5rem; border-radius: 0.375rem; margin-bottom: 0.6rem; font-size: 0.75rem; }
    .booking-image img { border-radius: 1.5rem; max-width: 80%; height: auto; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); display: block; margin: 0 auto; }
    .d-none { display: none; }
    @media (max-width: 1024px) {
        .booking-title { font-size: 3rem; }
        .booking-subtitle { font-size: 1.5rem; }
        .booking-image { margin-top: 2rem; }
    }
    @media (max-width: 640px) {
        .booking-section { padding: 3rem 0; }
        .booking-title { font-size: 2.25rem; }
        .booking-subtitle { font-size: 1.25rem; }
        .form-select-custom { font-size: 0.75rem; }
        .booking-image img { max-width: 90%; }
    }
  </style>
</head>
<body>
<header id="pq-header" class="pq-header-default">
  <div th:replace="fragments/fragment :: loginBar"></div>
  <nav th:replace="fragments/fragment :: menu"></nav>
</header>

<section class="booking-section" id="book">
  <div class="booking-shape">
    <svg width="1089" height="1002" viewBox="0 0 1089 1002" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path opacity="0.2" d="M444.57 826.314C529.104 1065.89 739.237 1008.47 834.547 949.171C981.567 843.507 997.742 626.309 999.967 542.103C1001.75 474.739 1058.26 303.318 1086.29 226.028C1115.11 -40.9119 843.814 0.833657 795.515 6.26561C747.215 11.6976 593.662 71.4673 441.083 40.606C319.02 15.917 205.529 28.8791 164.042 38.4462C-13.0065 100.952 -2.22156 200.043 3.13034 242.954C8.48234 285.864 53.2821 366.319 234.465 453.073C379.411 522.475 435.469 730.386 444.57 826.314Z" fill="url(#paint0_linear_5_285)"/>
      <defs>
        <linearGradient id="paint0_linear_5_285" x1="844.274" y1="950.214" x2="424.319" y2="-69.4782" gradientUnits="userSpaceOnUse">
          <stop stop-color="#86BBF1"/>
          <stop offset="1" stop-color="#D2EAEF"/>
        </linearGradient>
      </defs>
    </svg>
  </div>
  <div class="booking-container container mx-auto px-4">
    <div class="flex flex-wrap items-center -mx-4">
      <div class="w-full lg:w-1/2 px-4">
        <div id="titledlkb" class="mb-12">
          <h3 class="booking-subtitle">ĐẶT LỊCH</h3>
          <h2 class="booking-title">Khám Bệnh</h2>
        </div>
        <div id="message" class="alert d-none"></div>
        <form id="bookingForm" class="space-y-4">
          <div>
            <label class="form-label">Chuyên khoa</label>
            <select class="form-field form-select-custom chuyen-khoa" name="chuyenKhoaId">
              <option value="0">Chọn chuyên khoa</option>
            </select>
          </div>
          <div>
            <label class="form-label">Bác sỹ</label>
            <select class="form-field form-select-custom bac-sy" name="bacSyId">
              <option value="0">Chọn bác sỹ</option>
            </select>
          </div>
          <div>
            <label class="form-label">Giá tiền khám</label>
            <input class="form-field" type="text" name="tienKham" id="tienKham1" disabled>
          </div>
          <div>
            <label class="form-label">Ngày khám</label>
            <input class="form-field" type="date" name="ngayKham">
          </div>
          <div>
            <label class="form-label">Giờ khám</label>
            <select class="form-field form-select-custom" name="khungGioKham">
              <option value="0">Chọn giờ khám</option>
              <option value="1">8h</option>
              <option value="2">9h</option>
              <option value="3">10h</option>
              <option value="4">11h</option>
              <option value="5">12h</option>
              <option value="6">13h</option>
              <option value="7">14h</option>
              <option value="8">15h</option>
              <option value="9">16h</option>
              <option value="10">17h</option>
              <option value="11">18h</option>
              <option value="12">19h</option>
            </select>
          </div>
          <div>
            <label class="form-label">Mô tả triệu chứng</label>
            <textarea class="form-field form-textarea" placeholder="Mô tả triệu chứng" name="moTaTrieuChung" rows="4"></textarea>
          </div>
          <div>
            <button type="submit" id="btn_submitdatlich" class="btn-submit">
              <span>Đặt ngay</span>
              <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23ffffff'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 5l7 7-7 7'/%3E%3C/svg%3E" alt="Arrow">
            </button>
          </div>
        </form>
      </div>
      <div class="w-full lg:w-1/2 px-4 booking-image">
        <img src="/images/appointment.jpeg" alt="Appointment">
      </div>
    </div>
  </div>
</section>

<section th:replace="fragments/fragment :: footer"></section>
<script src="js/jquery.min.js"></script>
<!--bootstrap js-->
<script src="js/bootstrap.min.js"></script>
<!--owl-carousal-->
<script src="js/owl.carousel.min.js"></script>
<!--progress-bar js-->
<script src="js/progressbar.js"></script>
<!--isotope js-->
<script src="js/isotope.pkgd.min.js"></script>
<!--countTo js-->
<script src="js/jquery.countTo.min.js"></script>
<!--Maginfic-Popup js-->
<script src="js/jquery.magnific-popup.min.js"></script>
<!-- Animation JS -->
<script src="js/wow.min.js"></script>
<!-- Rev-Slider -->
<script src="js/rbtools.min.js"></script>
<script src="js/rs6.min.js"></script>
<script src="js/rev-custom.js"></script>
<!--custom js-->
<script src="js/custom.js"></script>
<script th:src="@{js/script.js}"></script>
<script>
  $(document).ready(function() {
    const baseUrl = window.location.origin + "/"; // Tự động lấy origin của trang hiện tại

    // Hàm hiển thị lỗi
    function showError(message) {
      $('#message').removeClass('d-none').addClass('alert-danger').text(message);
    }

    // Hàm kiểm tra số
    function isNumeric(str) {
      if (typeof str != "string") return false;
      return !isNaN(str) && !isNaN(parseFloat(str));
    }

    // Lấy danh sách chuyên khoa
    $.ajax({
      type: "GET",
      dataType: "json",
      url: baseUrl + "api/chuyen-khoa",
      success: function(data) {
        $('.chuyen-khoa').empty().append('<option value="0">Chọn chuyên khoa</option>');
        data.forEach(item => {
          let temp = `<option value="${item.id}">${item.ten}</option>`;
          $('.chuyen-khoa').append(temp);
        });
      },
      error: function(xhr, status, error) {
        showError("Không thể tải danh sách chuyên khoa. Vui lòng thử lại sau!");
        console.error("Lỗi khi lấy danh sách chuyên khoa:", xhr.responseText);
      }
    });

    // Lấy danh sách bác sĩ theo chuyên khoa
    $('.chuyen-khoa').on('change', function() {
      let id = $(this).val();
      if (!isNumeric(id) || id == 0) {
        $('.bac-sy').empty().append('<option value="0">Chọn bác sỹ</option>');
        $('#tienKham1').val('');
        return;
      }
      $.ajax({
        type: "GET",
        dataType: "json",
        url: baseUrl + "api/getAllBacSy/chuyenKhoa/" + id,
        success: function(data) {
          $('.bac-sy').empty().append('<option value="0">Chọn bác sỹ</option>');
          if (data.length == 0) {
            showError("Không có bác sĩ nào thuộc chuyên khoa này.");
            $('#tienKham1').val('');
            return;
          }
          data.forEach(item => {
            let temp = `<option value="${item.id}">${item.hoTen} - Chuyên khoa: ${item.chuyenKhoa.ten}</option>`;
            $('.bac-sy').append(temp);
          });
        },
        error: function(xhr, status, error) {
          showError("Không thể tải danh sách bác sĩ. Vui lòng thử lại sau!");
          console.error("Lỗi khi lấy danh sách bác sĩ:", xhr.responseText);
        }
      });
    });

    // Lấy giá tiền khám theo bác sĩ
    $('.bac-sy').on('change', function() {
      let id = $(this).val();
      if (!isNumeric(id) || id == 0) {
        $('#tienKham1').val('');
        return;
      }
      $.ajax({
        type: "GET",
        dataType: "json",
        url: baseUrl + "api/bacsy/" + id,
        success: function(data) {
          $('#tienKham1').val(data.tienKham.toLocaleString('vi-VN', {style: 'currency', currency: 'VND'}));
        },
        error: function(xhr, status, error) {
          showError("Không thể tải thông tin giá khám. Vui lòng thử lại sau!");
          console.error("Lỗi khi lấy thông tin bác sĩ:", xhr.responseText);
        }
      });
    });

    // Xử lý submit form
    $('#bookingForm').on('submit', function(e) {
      e.preventDefault();
      $('#message').addClass('d-none').removeClass('alert-success alert-danger');

      // Thu thập dữ liệu form
      const formData = {
        chuyenKhoaId: parseInt($('select[name="chuyenKhoaId"]').val()),
        bacSyId: parseInt($('select[name="bacSyId"]').val()),
        ngayKham: $('input[name="ngayKham"]').val(),
        khungGioKham: parseInt($('select[name="khungGioKham"]').val()),
        moTaTrieuChung: $('textarea[name="moTaTrieuChung"]').val().trim()
      };

      // Kiểm tra client-side
      if (!formData.chuyenKhoaId || formData.chuyenKhoaId <= 0) {
        showError("Vui lòng chọn chuyên khoa.");
        return;
      }
      if (!formData.bacSyId || formData.bacSyId <= 0) {
        showError("Vui lòng chọn bác sĩ.");
        return;
      }
      if (!formData.ngayKham) {
        showError("Vui lòng chọn ngày khám.");
        return;
      }
      const today = new Date().toISOString().split('T')[0];
      if (formData.ngayKham < today) {
        showError("Không thể chọn ngày trong quá khứ.");
        return;
      }
      const year = parseInt(formData.ngayKham.split('-')[0], 10);
      if (year < 1000 || year > 9999) {
        showError("Năm không hợp lệ, phải từ 1000-9999.");
        return;
      }
      if (!formData.khungGioKham || formData.khungGioKham <= 0) {
        showError("Vui lòng chọn giờ khám.");
        return;
      }
      if (!formData.moTaTrieuChung || formData.moTaTrieuChung.length < 2) {
        showError("Mô tả triệu chứng phải có ít nhất 2 ký tự.");
        return;
      }
      if (formData.moTaTrieuChung.length > 100) {
        showError("Mô tả triệu chứng không được vượt quá 100 ký tự.");
        return;
      }
      if (/[<>{}]/.test(formData.moTaTrieuChung)) {
        showError("Mô tả triệu chứng không được chứa ký tự đặc biệt như <, >, {, }.");
        return;
      }

      // Lấy JWT token
      const token = localStorage.getItem('jwtToken');
      if (!token) {
        showError("Vui lòng đăng nhập để đặt lịch.");
        window.location.href = '/dang-nhap';
        return;
      }

      // Gửi AJAX
      $.ajax({
        type: 'POST',
        url: baseUrl + 'api/booking/dat-lich',
        contentType: 'application/json',
        headers: { 'Authorization': 'Bearer ' + token },
        data: JSON.stringify(formData),
        success: function(response) {
          $('#message').removeClass('d-none').addClass('alert-success').text(response.success || 'Đặt lịch thành công!');
          setTimeout(() => { window.location.href = '/'; }, 2000);
        },
        error: function(xhr) {
          let errorMsg = 'Đặt lịch thất bại. Vui lòng thử lại!';
          try {
            const errorData = JSON.parse(xhr.responseText);
            errorMsg = errorData.error || errorMsg;
          } catch (e) {}
          showError(errorMsg);
          console.error("Lỗi khi đặt lịch:", xhr.responseText);
        }
      });
    });
  });
</script>

<script src="/js/script.js"></script>
</body>
</html>